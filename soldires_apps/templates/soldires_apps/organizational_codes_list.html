{% extends '../organizational_code_layout.html' %}
{% load static %}
{% load jalali_filters %}
{% load css %}

{% block page %}
<div class="row g-4">
    <!-- ÙÛŒÙ„ØªØ± Ùˆ Ø§ÙØ²ÙˆØ¯Ù† -->
    <div class="col-lg-4 col-md-12">
        <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
        <div class="ui-card">
            <div class="ui-card-header ui-card-header-primary">ğŸ” ÙÛŒÙ„ØªØ±Ù‡Ø§</div>
            <div class="ui-card-body space-y-3">
                <div class="ui-form-group xs">
                    <label for="searchInput">Ø¬Ø³ØªØ¬Ùˆ Ú©Ø¯ ÛŒØ§ Ù†Ø§Ù… Ø³Ø±Ø¨Ø§Ø²</label>
                    <input type="text" id="searchInput" class="ui-input" placeholder="Ú©Ø¯ ÛŒØ§ Ù†Ø§Ù…..." onkeyup="filterTable()">
                </div>

                <div class="ui-form-group xs">
                    <label for="sortSelect">Ù…Ø±ØªØ¨ Ø³Ø§Ø²ÛŒ</label>
                    <select id="sortSelect" class="ui-select" onchange="sortTable()">
                        <option value="">Ù…Ø±ØªØ¨ Ø³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³</option>
                        <option selected value="code_asc">Ú©Ø¯ â†‘</option>
                        <option value="code_desc">Ú©Ø¯ â†“</option>
                        <option value="soldier_asc">Ù†Ø§Ù… Ø³Ø±Ø¨Ø§Ø² â†‘</option>
                        <option value="soldier_desc">Ù†Ø§Ù… Ø³Ø±Ø¨Ø§Ø² â†“</option>
                    </select>
                </div>

                <div class="ui-form-group xs">
                    <label for="statusFilter">ÙˆØ¶Ø¹ÛŒØª</label>
                    <select id="statusFilter" class="ui-select" onchange="filterTable()">
                        <option selected value="all">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡</option>
                        <option value="active">ÙÙ‚Ø· ØºÛŒØ±Ø¢Ø²Ø§Ø¯</option>
                        <option value="inactive">ÙÙ‚Ø· Ø¢Ø²Ø§Ø¯</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø¯ Ø¬Ø¯ÛŒØ¯ -->
        <div style="margin-top: 20px;" class="ui-card">
            <div class="ui-card-header ui-card-header-primary">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø¯ Ø¬Ø¯ÛŒØ¯</div>
            <div class="ui-card-body">
                <form method="post" class="space-y-3">
                    {% csrf_token %}
                    <div class="ui-form-group">
                        {{ form.code_number.label_tag }}
                        {{ form.code_number|add_class:"ui-input" }}
                    </div>

                    <div class="ui-form-group items-center flex space-x-2">
                        {{ form.is_active }}
                        <span class="text-gray-700">{{ form.is_active.label }}</span>
                    </div>

                    <button type="submit" class="ui-btn ui-btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                </form>
            </div>
        </div>

    </div>
    <div class="col-lg-8 col-md-12">
        <div class="ui-card" style="max-height: 80vh; display: flex; flex-direction: column;">
            <div class="ui-card-header ui-card-header-primary">ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ</div>
            <div class="ui-card-body" style="overflow-y: auto; flex: 1;">
                <table class="table table-hover w-full text-center">
                    <thead class="bg-blue-500 text-white sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Ú©Ø¯ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ</th>
                            <th class="px-4 py-2">Ø³Ø±Ø¨Ø§Ø² ÙØ¹Ù„ÛŒ</th>
                            <th class="px-4 py-2">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÚ©Ù†Ù†Ø¯Ù‡</th>
                            <th class="px-4 py-2">ÙˆØ¶Ø¹ÛŒØª</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% if codes.exists %}
                            {% for code in codes %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 font-medium">{{ code.code_number }}</td>
                                    <td class="px-4 py-2">
                                        {% if code.current_soldier %}
                                            {{ code.current_soldier.first_name }} {{ code.current_soldier.last_name }}
                                        {% else %}
                                            <span class="text-gray-400">Ø®Ø§Ù„ÛŒ</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-2">{{ code.soldiers_count }}</td>
                                    <td class="px-4 py-2">
                                        {% if code.is_active %}
                                            <span name="active" class="badge badge-success">ØºÛŒØ±Ø¢Ø²Ø§Ø¯</span>
                                        {% else %}
                                            <span name="inactive" class="badge badge-secondary">Ø¢Ø²Ø§Ø¯</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-gray-400 py-4">âš ï¸ Ù‡ÛŒÚ† Ú©Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block footer %}
<script>
function filterTable() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const statusFilter = document.getElementById("statusFilter").value;
    const table = document.querySelector("table tbody");
    const rows = table.getElementsByTagName("tr");

    for (let i = 0; i < rows.length; i++) {
        const codeCell = rows[i].cells[0];
        const soldierCell = rows[i].cells[1];
        const statusSpan = rows[i].cells[3].querySelector("span");
        const statusName = statusSpan ? statusSpan.getAttribute("name") : "";

        let matchesText = codeCell.textContent.toLowerCase().includes(input) || soldierCell.textContent.toLowerCase().includes(input);
        let matchesStatus = statusFilter === "all" || (statusFilter === "active" && statusName==="active") || (statusFilter === "inactive" && statusName==="inactive");

        rows[i].style.display = (matchesText && matchesStatus) ? "" : "none";
    }
}

function sortTable() {
    const table = document.querySelector("table tbody");
    const rows = Array.from(table.querySelectorAll("tr"));
    const sortValue = document.getElementById("sortSelect").value;
    if (!sortValue) return;

    rows.sort((a, b) => {
        let aText = sortValue.includes("code") ? parseInt(a.cells[0].textContent.trim()) || 0 : a.cells[1].textContent.trim().toLowerCase();
        let bText = sortValue.includes("code") ? parseInt(b.cells[0].textContent.trim()) || 0 : b.cells[1].textContent.trim().toLowerCase();
        return sortValue.endsWith("_asc") ? (aText > bText ? 1 : -1) : (aText < bText ? 1 : -1);
    });

    rows.forEach(row => table.appendChild(row));
    filterTable();
}
</script>
{% endblock footer %}
