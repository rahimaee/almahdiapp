{% extends '../organizational_position_layout.html' %}
{% load static %}

{% block page %}
<style>
.tree-view {
    margin-top: 1rem;
}

/* کارت‌ها */
.tree-card {
    border: 1px solid #ddd;
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.05);
    overflow: hidden;
}

.tree-header {
    background-color: #0d6efd;
    color: #fff;
    font-weight: 600;
    padding: 0.6rem 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease-in-out;
}

.tree-header:hover {
    background-color: #0056b3;
}

.tree-body {
    display: none;
    background-color: #f8f9fa;
    padding: 0.5rem 1rem;
}

/* گروه‌ها */
.tree-group {
    margin: 0.5rem 0;
    padding: 0.5rem;
    background-color: #ffffff;
    border: 1px solid #e1e1e1;
    border-radius: 0.4rem;
}

.tree-group-header {
    cursor: pointer;
    font-weight: 500;
    color: #0d6efd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tree-group-body {
    display: none;
    margin-top: 0.4rem;
    padding-left: 1rem;
}

/* جایگاه‌ها */
.tree-position {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding: 0.4rem 0;
}

.tree-position:last-child {
    border-bottom: none;
}

/* آیکون‌ها */
.tree-toggle-icon {
    transition: transform 0.2s;
}
.active .tree-toggle-icon {
    transform: rotate(-90deg);
}
</style>


<div class="container mt-3">
    <h4 class="mb-3"><i class="fa fa-sitemap text-success"></i> {{ page_title }}</h4>
    <p class="text-muted">{{ description }}</p>

    {% if tree %}
        <div class="tree-view">
            {% for parent_name, parent in tree.items %}
                <div class="tree-card">
                    <div class="tree-header {% if forloop.first %}active{% endif %}">
                        <span><i class="fa fa-building"></i> {{ parent.label }}</span>
                        <div>
                            <span class="badge bg-light text-dark">جایگاه‌ها: {{ parent.positions_count }}</span>
                            <span class="badge bg-warning text-dark">سربازان: {{ parent.soldiers_count }}</span>
                            <i class="fa fa-chevron-left tree-toggle-icon ms-2"></i>
                        </div>
                    </div>

                    <div class="tree-body" {% if forloop.first %}style="display:block;"{% endif %}>
                        {% for group in parent.children %}
                            <div class="tree-group">
                                <div class="tree-group-header">
                                    <span><i class="fa fa-folder-open"></i> {{ group.label }}</span>
                                    <div>
                                        <span class="badge bg-light text-dark">جایگاه‌ها: {{ group.positions_count }}</span>
                                        <span class="badge bg-secondary text-white">سربازان: {{ group.soldiers_count }}</span>
                                        <i class="fa fa-chevron-left tree-toggle-icon"></i>
                                    </div>
                                </div>

                                <div class="tree-group-body">
                                    {% if group.positions %}
                                        {% for pos in group.positions %}
                                            <div class="tree-position">
                                                <div>
                                                    <i class="fa fa-user-tie text-secondary"></i>
                                                    <strong>{{ pos.position_code }}</strong>  
                                                    {% if pos.soldier %}
                                                        - 
                                                        <span>
                                                           {{ pos.soldier|default:"بدون تخصیص" }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <span class="text-muted small">{{ pos.soldiers.count }} سرباز</span>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted small">هیچ جایگاهی ثبت نشده است.</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">هیچ داده‌ای برای نمایش وجود ندارد.</div>
    {% endif %}
</div>


<!-- Scripts -->
<script src="{% static 'bower_components/jquery/dist/jquery.min.js' %}"></script>
<script>
$(document).ready(function(){

    // والد سطح ۱ (parent groups)
    $(".tree-header").click(function(){
        const body = $(this).next(".tree-body");
        $(".tree-body").not(body).slideUp();
        $(".tree-header").not(this).removeClass("active");
        body.slideToggle();
        $(this).toggleClass("active");
    });

    // گروه‌های سطح ۲
    $(".tree-group-header").click(function(){
        const body = $(this).next(".tree-group-body");
        $(".tree-group-body").not(body).slideUp();
        $(".tree-group-header").not(this).removeClass("active");
        body.slideToggle();
        $(this).toggleClass("active");
    });
});
</script>
{% endblock %}
