{% extends "layouts/expired_soldiers_layout.html" %}

{% block page %}
<style>
    /* کارت های مدرن */
    .expired-card {
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.15);
        margin-bottom: 1rem;
    }
    .expired-card h3 {
        padding: 0;
        margin: 0;
        font-size: 20px;
    }
    .card-header {
        font-weight: 600;
        font-size: 1.05rem;
    }
    .expired-card .card-body {
        padding: 10px;
    }
    .progress-bar.bg-gradient {
        background: linear-gradient(90deg, #0d6efd, #6610f2);
        transition: width 0.3s ease-in-out;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    /* اینپوت متن */
    .modern-input {
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }

 

    /* اینپوت فایل */
    .modern-file-input {
        display: none;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem 0 0 0.75rem;
        cursor: pointer;
    }


    /* دکمه انتخاب فایل */
    .input-group-text.btn {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        transition: all 0.3s ease;
        background-color: #0d6efdaa;
        color: #fff;
    }

    .input-group-text.btn:hover {
        background-color: #0d6efd;
    }
    .input-group {
        display: flex;
        border:2px solid #0d6efd;
        border-radius:  0.75rem ;
        overflow: hidden;
        display: flex;
        align-items: center;
        padding: 0  10px ;
    }
    .input-group label {
        flex: 1;
    }
    .input-group  input {
        flex: 3;
        border: none;
        outline: none;
        box-shadow: none;
        padding: 10px;
        min-height: 40px;

    }

    .helper-card p {
        line-height: 1.6;
    }

    .helper-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        font-size: 1.1rem;
    }

    .helper-table th, .helper-table td {
        text-align: center;
        vertical-align: middle;
        padding: 0.55rem 0.75rem;
    }
  /* جدول در یک خط بماند */
  .helper-table th,
  .helper-table td {
    white-space: nowrap !important;
    vertical-align: middle !important;
  }

  /* جدول اسکرول افقی بگیرد بدون فشرده شدن */
  .table-container {
    width: 100%;
    overflow-x: auto;
  }


  /* استایل فیلدهای الزامی */
  .required-field {
    background-color: #fdc5c5ff !important;
    color: #b30000;
    font-weight: bold;
  }
  .required-field::after {
    content: '*';
  }

  .required-cell {
    background-color: #fde9e9ff;
    font-weight: bold;
  }
    .helper-table th {
        font-weight: 600;
        color: #495057;
    }

    .helper-table td {
        color: #495057;
    }

    .helper-table tbody tr:hover {
        background-color: #f1f3f5;
        transition: 0.2s;
    }

    .helper-table th:first-child, .helper-table td:first-child {
        border-top-left-radius: 0.5rem;
        border-bottom-left-radius: 0.5rem;
    }

    .helper-table th:last-child, .helper-table td:last-child {
        border-top-right-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
    }
</style>
<div class="">
    <div class="row g-4">
        <!-- فرم آپلود فایل -->
         <div class="col-md-12">
            <div class="expired-card helper-card shadow-lg border-0 rounded-4">
                                <div style="display: flex;align-items: center;justify-content: space-between;">
                    <h3 class="card-header  d-flex align-items-center">
                        <i class="fa fa-info me-2"></i> راهنما
                    </h3>
                     <a href="{% url 'expired_soldiers_import_group_sample_excel' %}" class="btn btn-success btn-sm w-100">
                            <i class="fa fa-file "></i> دانلود اکسل نمونه جهت آماده سازی
                    </a>
                </div>
                <div class="card-body">
                   <p class="mb-3 text-muted" style="font-size: 1.3rem;">
                        - <strong>کد ملی</strong> و <strong>نام کامل</strong> اجباری هستند.<br>
                        - تاریخ‌ها باید به فرمت 
                        <code>YYYY/MM/DD</code>
                        <code>YYYY.MM.DD</code>
                        <code>YYYY-MM-DD</code>
                        <code>YYYY,MM,DD</code>
                        وارد شوند. در غیر این صورت خالی یا ناشناخته در نظر گرفته می‌شوند.<br>
                        - <strong>دلیل تسویه</strong> می‌تواند یکی از موارد زیر باشد: 
                        {% for key, value in EXPIRED_REASON_CHOICES %}
                            <code style="margin: 0 4px;">
                                {{ value }}
                                <i class="fa fa-copy text-primary copy-btn"  style="cursor:pointer; margin-right:5px;"  title="کپی کردن" data-value="{{ value }}"></i>
                            </code>
                        {% endfor %} 
                        . در غیر این صورت به صورت منقضی خدمت ثبت می‌شود.<br>
                        - در صورتی که کد ملی از قبل وجود داشته باشد، اطلاعات سرباز بروزرسانی خواهد شد. لطفاً دقت فرمایید.
                    </p>

                    <div class="table-responsive" style="width: 100%;min-width: 100%;min-height: 100%;overflow-x: scroll;" >
                        <table  class="table table-striped table-bordered helper-table">
                            <thead class="table-light">
                                <tr>
                                    <th>پرونده</th>
                                    <th>شماره پرونده</th>
                                    <th class="required-field">کد ملی</th>
                                    <th>شماره شناسنامه</th>
                                    <th>نام</th>
                                    <th>نام خانوادگی</th>
                                    <th>نام پدر</th>
                                    <th>کد سربازی</th>
                                    <th>تاریخ شروع خدمت</th>
                                    <th>تاریخ فرار</th>
                                    <th>تاریخ پایان خدمت</th>
                                    <th>تاریخ تسویه</th>
                                    <th>دلیل منقضی شدن</th>
                                    <th>بررسی وضعیت</th>
                                    <th>وضعیت</th>
                                    <th>توضیحات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>*</td>
                                    <td>8100</td>
                                    <td class="required-cell">1234567890</td>
                                    <td>2150604736</td>
                                    <td >سجاد</td>
                                    <td>سیفی لر</td>
                                    <td>ایمان</td>
                                    <td>100</td>
                                    <td>1403/11/01</td>
                                    <td></td>
                                    <td>1405/01/01</td>
                                    <td>1405/01/16</td>
                                    <td>پایان خدمت</td>
                                    <td>بررسی شد</td>
                                    <td>فعال</td>
                                    <td>---</td>
                                </tr>
                                <tr>
                                    <td>*</td>
                                    <td>8194</td>
                                    <td class="required-cell">2051086672</td>
                                    <td>2051086672</td>
                                    <td>عرشیا</td>
                                    <td>پرسا</td>
                                    <td>وحید</td>
                                    <td>194</td>
                                    <td>1403/11/01</td>
                                    <td></td>
                                    <td>1405/03/01</td>
                                    <td>1405/03/01</td>
                                    <td>پایان خدمت</td>
                                    <td>درحال بررسی</td>
                                    <td>فعال</td>
                                    <td>---</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
         </div>
        <div class="col-md-5">
            <div class="expired-card shadow-lg border-0 rounded-4 overflow-hidden">
                <h3 class="card-header  d-flex align-items-center">
                    <i class="fa fa-upload me-2"></i> بارگذاری اکسل سربازان
                </h3>
                <div class="card-body">
                    <div class="input-group">
                        <label class="input-group-text btn btn-outline-primary" for="upload_file">
                            <i class="fa fa-upload me-2"></i> انتخاب فایل
                        </label>
                        <input  type="file" id="upload_file" class="modern-file-input">
                    </div>
                    <div style="margin-top: 10px;" class="input-group" >
                        <label for="custom_filename" class="input-group-text btn btn-outline-primary">نام فایل (اختیاری)</label>
                        <input type="text" id="custom_filename" class="modern-input" placeholder="اگر خالی باشد نام اصلی فایل استفاده می‌شود">
                    </div>

                    <div class="progress  rounded-3" style="height: 28px; display:none;">
                        <div id="progress_bar" class="progress-bar progress-bar-striped progress-bar-animated bg-gradient" role="progressbar" style="width: 0%;">0%</div>
                    </div>

                    <div id="upload_status" class="mb-2 text-success fw-bold"></div>
                    <div style="margin-top: 20px;" >
                        <button id="upload_btn" style="width: 100%;" class="btn btn-primary btn-sm rounded-pill">
                            <i class="fa fa-upload me-2"></i> بارگذاری فایل
                        </button>
                    </div>
                </div>

            </div>

            <div class="expired-card shadow-lg border-0 rounded-4 mt-4 overflow-hidden">
                <h3 class="card-header  d-flex align-items-center">
                    <i class="fa fa-folder-open me-2"></i> فایل های اپلود شده
                </h3>
                <div class="card-body p-2">
                    <form id="file-action-form" method="POST" action="{% url 'expired_soldiers_import_group_action' %}">
                        {% csrf_token %}
                        <input type="hidden" name="filename" id="filename-input">
                        <input type="hidden" name="action_type" id="action-type-input">

                        <ul class="list-group list-group-flush">
                        {% for file in files %}
                            <li 
                                data-filename="{{file.filename}}"
                                data-fileurl="{{ file.url }}"
                                class="list-group-item" 
                                style="font-size:11px;flex-direction: column;align-items: start;justify-content: start;"
                            >
                                <div style="font-size: 14px;font-weight: bold;display: flex;justify-content: space-between;align-items:center;width: 100%;">
                                    <div style=""><i class="fa fa-file text-success"></i> {{ file.base_name }}</div> 
                                    <div style="flex: 1;"></div>
                                    <div
                                        dir="ltr"
                                        style="background-color: green; color: white;padding: 2px 4px; border-radius: 4px;"
                                    >
                                        {{ file.ext }}
                                    </div>
                                </div>
                                <div style="display: flex;justify-content: end;width: 100%;margin-top: 10px;">
                                    <div style="flex: 1;">
                                       <i class="fa fa-calendar"></i> <span dir="ltr">{{file.created_at_display}}</span>
                                    </div>

                                    <button 
                                        type="submit" 
                                        data-action="show" 
                                        style="font-size:11px;" 
                                        class="btn btn-xs btn-info file-action-btn" 
                                    >
                                        نمایش <i class="fa fa-eye" style="font-size:11px;"></i>
                                    </a>
                                    <button 
                                        type="submit" 
                                        data-action="download"
                                        style="font-size:11px;margin:0 6px;"  
                                        class="btn btn-xs btn-success file-action-btn" 
                                        download
                                    >
                                        دانلود <i class="fa fa-download" style="font-size:11px;"></i>
                                    </button>
                                    <button 
                                        type="submit" 
                                        data-action="delete" 
                                        style="font-size:11px;"
                                        class="btn btn-xs btn-danger file-action-btn"
                                    >
                                        حذف <i class="fa fa-trash" style="font-size:11px;"></i>
                                    </button>
                                    <button 
                                        type="submit" 
                                        data-action="process"
                                        class="btn btn-xs btn-warning file-action-btn"
                                        style="font-size:11px;"
                                        id="btn-process-{{ f.task_id }}"
                                        {% if file.is_processing  %}disabled{% endif %}
                                    >
                                         پردازش 
                                       <i class="fa fa-play" style="font-size:11px;"></i>
                                    </button>
                                </div>
                            </li>
                        {% empty %}
                            <div class="text-muted text-center">هیچ فایلی آپلود نشده است</div>
                        {% endfor %}
                        </ul>
                    </form>

                </div>
            </div>
        </div>

        <!-- وضعیت پردازش و رکوردها -->
        <div class="col-md-7">
            <div class="expired-card shadow-lg border-0 rounded-4">
                <h3 class="card-header  d-flex align-items-center">
                    <i class="fa fa-check-circle me-2"></i> پردازش و اخرین رکورد ها
                </h3>
                <div class="card-body p-2">
                    {% for file in processing_files %}
                        <div id="sec-task-{{file.task_id}}" class="file-item">
                            <div style="display: flex;align-items: center;justify-content: space-between;">
                                <h5>
                                    پردازش {{ file.filename }}
                                </h5>
                                <div style="flex: 1;"></div>
                                <div>
                                    <strong>کل : </strong>
                                    <span id="all-task-{{file.task_id}}">0</span>
                                </div>
                                <div>
                                    <strong>موفق : </strong>
                                    <span id="success-task-{{file.task_id}}">0</span>
                                </div>
                                <div>
                                    <strong>خطا : </strong>
                                    <span id="error-task-{{file.task_id}}">0</span>
                                </div>
                            </div>
                            <div class="progress mt-2">
                                <div  id="task-progress-{{ file.task_id }}" class="progress-bar" role="progressbar" style="width:0%">
                                    0%
                                </div>
                                <div  id="error-progress-{{ file.task_id }}" class="progress-bar" role="progressbar" style="width:0%;background-color: red;">
                                </div>
                            </div>
                            <ul 
                            style="max-height: 200px;overflow-y: scroll;"
                            id="last-process-{{file.task_id}}" class="list-group list-group-flush">
                                
                            </ul>
                        </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
</div>



<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("file-action-form");
    const filenameInput = document.getElementById("filename-input");
    const actionTypeInput = document.getElementById("action-type-input");

    // تمام دکمه‌هایی که عملیات دارند
    const actionButtons = form.querySelectorAll("button[data-action]");

    actionButtons.forEach(button => {
        button.addEventListener("click", event => {
            event.preventDefault(); // جلوگیری از ارسال خودکار فرم تا داده‌ها تنظیم شوند

            // والد دکمه (li) که داده‌های فایل در آن است
            const listItem = button.closest("li");

            // گرفتن اطلاعات فایل از li
            const filename = listItem.getAttribute("data-filename");
            const actionType = button.getAttribute("data-action");

            // قرار دادن داده‌ها در inputهای مخفی فرم
            filenameInput.value = filename;
            actionTypeInput.value = actionType;

            // اگر اکشن "نمایش" است → فایل را در تب جدید باز کن
            if (actionType === "show") {
                const fileUrl = listItem.getAttribute("data-fileurl");
                if (fileUrl) {
                    window.open(fileUrl, "_blank");
                } else {
                    alert("آدرس فایل یافت نشد.");
                }
                return; // فرم ارسال نشود
            }

            // در غیر این صورت (دانلود، حذف، پردازش) → فرم را ارسال کن
            form.submit();
        });
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const copyButtons = document.querySelectorAll(".copy-btn");

    copyButtons.forEach(btn => {
        btn.addEventListener("click", function() {
            const textToCopy = this.getAttribute("data-value");
            
            // ایجاد یک المان موقت برای کپی
            const tempInput = document.createElement("input");
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);

            // نمایش پیغام کوتاه به کاربر (اختیاری)
            alert(`متن "${textToCopy}" کپی شد!`);
        });
    });
});

        {% if has_processing %}
            async function fetchActiveTasks() {
                try {
                    const res = await fetch("{% url "expired_soldiers_task_active" %}");
                    const tasks = await res.json();
                    tasks.forEach(task => {
                        const task_id = task.task_id;
                        const finished = task.finished;
                        if (finished){
                            const task = document.querySelector(`#sec-task-${task_id}`);
                            if(task){
                                // task.parentNode.removeChild(task)
                            }
                            const btnProgress = document.querySelector(`#btn-process-${task_id}`);
                            if(btnProgress)
                            {
                                btnProgress.style.disabled=false;
                            }
                        }
                        
                        const filename = task.filename;
                        
                        const progress = task.progress || {};
                        const total = task.total_count || 1;
                        const processed = task.processed_count || 0;
                        const error = task.error_count || 0;
                        const percent = Math.floor((processed / total) * 100);
                        const errorPercent = Math.floor((error / total) * 100);
                        const last_processed = task.last_processed
                        // بروزرسانی آمارها
                        const allTaskEl = document.querySelector(`#all-task-${task_id}`);
                        const successEl = document.querySelector(`#success-task-${task_id}`);
                        const errorEl = document.querySelector(`#error-task-${task_id}`);

                        if(allTaskEl) allTaskEl.textContent = total;
                        if(successEl) successEl.textContent = processed;
                        if(errorEl) errorEl.textContent = error;

                        // بروزرسانی progress bar
                        const bar = document.querySelector(`#task-progress-${task_id}`);
                        if(bar){
                            bar.style.width = percent + '%';
                            bar.textContent = percent + '%';
                        }
                        const errorBar = document.querySelector(`#error-progress-${task_id}`);
                        if(bar){
                            errorBar.style.width = errorPercent + '%';
                            errorBar.textContent = errorPercent + '%';
                        }
                        // غیرفعال کردن دکمه پردازش
                        const btn = document.querySelector(`#btn-progress-${task_id}`);
                        if(btn){
                            btn.disabled = !progress.finished;
                        }
                        const lastProcessEl = document.querySelector(`#last-process-${task_id}`);
                        if(lastProcessEl){
                            lastProcessEl.innerHTML = last_processed.map(r => `
                                <li   class="list-group-item" >
                                    <div>
                                        ${r.first_name} ${r.last_name}
                                    </div>
                                    <div>
                                        ${r.__message}
                                    </div>    
                                </li>
                            `).join('');
                        }
                    });
                } catch (err) {
                    console.error(err);
                }
            }

            // هر ۳ ثانیه polling
            setInterval(fetchActiveTasks, 1000);
        {% endif %}
</script>

{% endblock %}

{% block footer %}
<script>
    $(document).ready(function() {
        function resetProcessStatus() {
            $('#processed_count').text('0');
            $('#total_count').text('0');
            $('#error_count').text('0');
            $('#eta_time').text('--');
            $('#per_record_time').text('--');
        }

        $('#upload_btn').on('click', function(e) {
            e.preventDefault();
            var fileInput = $('#upload_file')[0].files[0];
            if (!fileInput) { alert("لطفاً فایل اکسل را انتخاب کنید."); return; }

            var customName = $('#custom_filename').val().trim();
            var formData = new FormData();
            formData.append('file', fileInput);
            formData.append('filename', customName);

            $('.progress').show();
            $('#progress_bar').css('width','0%').text('0%');
            $('#upload_status').text('');
            $('#execute_process').prop('disabled', true);
            resetProcessStatus();

            $.ajax({
                url: "{% url 'expired_soldiers_import_group_upload' %}",
                type: "POST",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: formData,
                processData: false,
                contentType: false,
                xhr: function() {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function(evt) {
                        if(evt.lengthComputable){
                            var percent = Math.round((evt.loaded / evt.total) * 100);
                            $('#progress_bar').css('width', percent+'%').text(percent+'%');
                        }
                    }, false);
                    return xhr;
                },
                success: function(response) {
                    $('#upload_status').text("آپلود موفق: " + response.filename);
                    $('#execute_process').prop('disabled', false);
                    $('#upload_file').val('');
                    $('#custom_filename').val('');
                    // آپدیت لیست فایل های آپلود شده
                    location.reload();
                },
                error: function() {
                    $('#upload_status').addClass('text-danger').text("خطا در آپلود فایل!");
                }
            });
        });

        $('#execute_process').on('click', function() {
            $(this).prop('disabled', true);
            $('#process_status').append('<div class="text-info">پردازش در حال اجرا...</div>');

            $.ajax({
                url: "{% url 'expired_soldiers_import_group_process_uploaded' %}",
                type: "POST",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function(response){
                    $('#processed_count').text(response.processed);
                    $('#total_count').text(response.total);
                    $('#error_count').text(response.errors);
                    $('#eta_time').text(response.eta);
                    $('#per_record_time').text(response.per_record_time);
                    $('#process_status').append('<div class="text-success">پردازش تکمیل شد</div>');
                },
                error: function(){
                    $('#process_status').append('<div class="text-danger">خطا در پردازش فایل!</div>');
                }
            });
        });
    });
</script>

{% endblock%}