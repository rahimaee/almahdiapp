{% extends 'shared/_PanelMain.html' %}
{% load static %}
{% load jalali_filters %}
{% block header %}
    <style>
        body {
            direction: rtl;
            background: #f5f5f5;
            font-family: 'Tahoma';
        }

        .container {
            margin-top: 40px;
        }

        h2 {
            margin-bottom: 30px;
            color: #2c3e50;
            font-weight: bold;
        }

        .custom-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .custom-table th {
            background: #27ae60;
            color: white;
            text-align: center;
            font-size: 13px;
        }

        .custom-table td {
            text-align: center;
            vertical-align: middle !important;
            font-size: 13px;
        }

        .btn-export {
            margin-bottom: 20px;
        }
    </style>
{% endblock %}

{% block main %}

    <div class="container">
        <h2 class="text-center">جدول افراد و گروه های ناصرین</h2>

        <button class="btn btn-success btn-export" onclick="exportToExcel()">📥 خروجی اکسل لیست</button>

        <div class="table-responsive">
            <table class="table table-bordered custom-table" id="dataTable">
                <thead>
                <tr>
                    <th>کد سازمانی</th>
                    <th>کد ملی</th>
                    <th>نام</th>
                    <th>نام خانوادگی</th>
                    <th>مقطع تحصیلی</th>
                    <th>سطح</th>
                    <th>شماره همراه</th>
                    <th>نام گروه</th>
                    <th>نام سرگروه</th>
                    <th>وضعیت فرار</th>
                    <th>نام قسمت</th>
                    <th>زیرقسمت</th>
                    <th>تاریخ پایان</th>
                    <th>عملیات</th>
                </tr>
                </thead>
                <tbody>
                {% for soldire in soldires %}
                    <tr>
                        <td>{{ soldire.organizational_code.code_number }}</td>
                        <td>{{ soldire.national_code }}</td>
                        <td>{{ soldire.first_name }}</td>
                        <td>{{ soldire.last_name }}</td>
                        <td>{{ soldire.degree }}</td>
                        <td>1</td>
                        <td>{{ soldire.phone_mobile }}</td>
                        <td>
                            {% if soldire.naserin_group %}
                                {{ soldire.naserin_group.name }}
                            {% else %}
                                ندارد
                            {% endif %}
                        </td>
                        <td>
                            {% if soldire.naserin_group %}
                                {{ soldire.naserin_group.manager.get_full_name }}
                            {% else %}
                                ندارد
                            {% endif %}
                        </td>
                        <td>
                            {% if soldire.is_fugitive %}
                                بله
                            {% else %}
                                خیر
                            {% endif %}
                        </td>
                        <td>{{ soldire.current_parent_unit.name }}</td>
                        <td>{{ soldire.current_sub_unit.name }}</td>
                        <td>{{ soldire.service_end_date|to_jalali }}</td>
                        <td>
                            <a href="{% url 'edit_soldier_naserin' soldier_id=soldire.id %}">تخصیص گروه</a>
                            <a href="{% url 'soldier_detail' pk=soldire.id %}">مشاهده فرد</a>
                        </td>

                    </tr>
                {% endfor %}
                <!-- ردیف‌های بیشتر -->
                </tbody>
            </table>
        </div>
    </div>

{% endblock %}


{% block footer %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        function exportToExcel() {
            var table = document.getElementById("dataTable");
            var ws = XLSX.utils.aoa_to_sheet([]);

            for (let i = 0; i < table.rows.length; i++) {
                let row = [];
                for (let j = 0; j < table.rows[i].cells.length; j++) {
                    let cellText = table.rows[i].cells[j].innerText.trim();
                    row.push({v: cellText, t: "s"}); // force text (string) type
                }
                XLSX.utils.sheet_add_aoa(ws, [row], {origin: -1});
            }

            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "جدول_افراد.xlsx");
        }
    </script>
{% endblock %}