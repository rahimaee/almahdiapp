{% extends 'shared/_PanelMain.html' %}
{% load static %}

{% block header %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
{% endblock %}

{% block main %}
    <div class="container">
        <h2 class="text-center">لیست سربازان و دوره عقیدتی</h2>
        <button class="btn btn-success" id="download-btn" style="margin-bottom: 15px;">دانلود اکسل</button>
        <table id="soldiers-table" class="table table-bordered table-striped">
            <thead>
            <tr>
                <th>#</th>
                <th>کدسازمانی</th>
                <th>نام</th>
                <th>نام خانوادگی</th>
                <th>کد ملی</th>
                <th>قسمت</th>
                <th>زیر قسمت</th>
                <th>مدرک</th>
                <th>درجه</th>
                <th>موبایل</th>
                <th>نام دوره عقیدتی</th>
                <th>تاریخ عقیدتی</th>
                <th>توضیحات عقیدتی</th>
                <th>عملیات</th>
            </tr>
            </thead>
            <tbody>
            {% for soldier in soldiers %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ soldier.organizational_code.code_number }}</td>
                    <td>{{ soldier.first_name }}</td>
                    <td>{{ soldier.last_name }}</td>
                    <td>{{ soldier.national_code }}</td>
                    <td>{{ soldier.current_parent_unit.name }}</td>
                    <td>{{ soldier.current_sub_unit.name }}</td>
                    <td>{{ soldier.degree }}</td>
                    <td>{{ soldier.rank }}</td>
                    <td>{{ soldier.phone_mobile }}</td>
                    <td>{{ soldier.ideological_training_period.name }}</td>
                    <td>{{ soldier.ideological_training_period.date }}</td>
                    <td>{{ soldier.ideological_training_period.description }}</td>
                    <td>
                        <a href="{% url 'soldier_detail' pk=soldier.id %}" class="btn btn-info btn-sm">اطلاعات سرباز</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="14" class="text-center">هیچ سربازی پیدا نشد.</td>
                </tr>
            {% endfor %}
            </tbody>

        </table>
    </div>
{% endblock %}

{% block footer %}
    <script>
        document.getElementById('download-btn').addEventListener('click', function () {
            // گرفتن جدول
            var table = document.getElementById('soldiers-table');

            // تبدیل جدول به فرمت اکسل
            var wb = XLSX.utils.table_to_book(table, {sheet: 'Soldiers With Training'});  // نام شیت کوتاه‌تر شد

            // دستکاری سلول‌ها برای تبدیل داده‌ها به رشته
            var sheet = wb.Sheets['Soldiers With Training'];
            for (var row = 1; row <= sheet['!rows']; row++) {
                for (var col = 0; col < sheet['!cols']; col++) {
                    var cell = sheet[XLSX.utils.encode_cell({r: row, c: col})];
                    if (cell) {
                        // تبدیل سلول به رشته
                        cell.v = String(cell.v);
                    }
                }
            }

            // ایجاد فایل اکسل و دانلود آن
            XLSX.writeFile(wb, 'soldiers_With_training.xlsx');
        });
    </script>
{% endblock %}
